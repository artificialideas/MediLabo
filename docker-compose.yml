version: "3.8"

services:
  # Databases
  mssqldb:
    image: mcr.microsoft.com/mssql/server
    container_name: mssqldb
    restart: always
    environment:
      ACCEPT_EULA: Y
      MSSQL_DATABASE: ${MSSQL_DB}
      MSSQL_USER : ${MSSQL_U}
      MSSQL_PASSWORD: ${MSSQL_PWD}
    volumes:
      - ./medilabo-patients/src/main/resources/init-mssql.sql:/docker-entrypoint-initdb.d/init-mssql.sql
    ports:
      - "1433:1433"
  mongodb:
    image: mongo:latest
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_DATABASE: ${MG_DB}
    volumes:
      - ./medilabo-notes/src/main/resources/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    ports:
      - "27018:27017"

  # Services
  medilabo-gateway:
    build:
      context: ./medilabo-gateway
      dockerfile: Dockerfile
    image: medilabo-gateway
    ports:
      - "9000:9000"

  medilabo-patients:
    build:
      context: ./medilabo-patients
      dockerfile: Dockerfile
    image: medilabo-patient
    depends_on:
      mssqldb:
        condition: service_healthy
    ports:
      - "9001:9001"
    restart: on-failure

  medilabo-notes:
    build:
      context: ./medilabo-notes
      dockerfile: Dockerfile
    image: medilabo-notes
    depends_on:
      mongodb:
        condition: service_healthy
    ports:
      - "9002:9002"
    restart: on-failure

  medilabo-assessments:
    build:
      context: ./medilabo-assessments
      dockerfile: Dockerfile
    image: medilabo-assessments
    depends_on:
      medilabo-patients:
        condition: service_healthy
      medilabo-notes:
        condition: service_healthy
    ports:
      - "9003:9003"
    restart: on-failure

  medilabo-frontend:
    build:
      context: ./medilabo-frontend
      dockerfile: Dockerfile
    image: medilabo-frontend
    depends_on:
      medilabo-patients:
        condition: service_healthy
      medilabo-notes:
        condition: service_healthy
      medilabo-gateway:
        condition: service_healthy
      medilabo-assessments:
        condition: service_healthy
    ports:
      - "4200:4200"
    restart: on-failure

